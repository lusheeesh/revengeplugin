(function(A,g,h,s,u,m,C,_,E,P){"use strict";async function D(e){const t=await e.arrayBuffer(),n=(await new AudioContext().decodeAudioData(t)).getChannelData(0),o=64,a=Math.floor(n.length/o),r=[];for(let i=0;i<o;i++){const f=i*a;let d=0;for(let l=0;l<a;l++)d+=Math.abs(n[f+l]||0);r.push(Math.min(1,d/a*10))}const c=new Uint8Array(r.map(function(i){return Math.floor(i*255)}));return btoa(String.fromCharCode(...c))}async function L(e){if(!e?.file||!e.mimeType?.startsWith("audio"))return;const t=e.file,n=await new Promise(function(a){const r=new Audio(URL.createObjectURL(t));r.addEventListener("loadedmetadata",function(){a(r.duration||0),URL.revokeObjectURL(r.src)}),r.addEventListener("error",function(){return a(0)})}),o=await D(t);e.mimeType="audio/ogg",e.waveform=o,e.durationSecs=n||1}function U(){const e=[],t=function(n){const o=g.findByProps(n);if(!o||typeof o[n]!="function")return;const a=h.before(n,o,async function(r){const c=r?.[0];if(!c||!s.storage.sendAsVM||c.flags===8192)return;const i=c.items?.[0]??c;i?.mimeType?.startsWith("audio")&&(await L(i),c.flags=8192)});e.push(a)};return t("uploadLocalFiles"),t("CloudUpload"),function(){return e.forEach(function(n){return n()})}}function I(){const e=new Uint8Array(64);for(let t=0;t<64;t++)e[t]=Math.floor(Math.random()*200)+30;return btoa(String.fromCharCode(...e))}function B(e){if(!e?.attachments?.length)return;let t=!1;for(const n of e.attachments)n?.content_type?.startsWith?.("audio")&&(n.waveform||(n.waveform=I()),n.duration_secs||(n.duration_secs=Math.floor(Math.random()*10)+20),t=!0);t&&(e.flags=(e.flags??0)|8192)}function M(e){const t=u.FluxDispatcher._actionHandlers._computeOrderedActionHandlers(e).find(function(n){return n.name==="MessageStore"});return t?h.before("actionHandler",t,function(n){if(!s.storage.allAsVM)return;const o=n?.[0];if(!o)return;const a=o.messages??[o.message];if(a)for(const r of a)r.flags!==8192&&B(r)}):function(){}}const F=function(){return M("LOAD_MESSAGES_SUCCESS")},T=function(){return M("MESSAGE_CREATE")},N=function(){return M("MESSAGE_UPDATE")},{FormRow:S}=E.Forms,w=g.findByProps("ActionSheetRow")?.ActionSheetRow;function v({label:e,icon:t,onPress:n}){const o=u.stylesheet.createThemedStyleSheet({iconComponent:{width:24,height:24,tintColor:_.semanticColors.INTERACTIVE_NORMAL}});return w?React.createElement(w,{label:e,icon:React.createElement(w.Icon,{source:t,IconComponent:function(){return React.createElement(u.ReactNative.Image,{resizeMode:"cover",style:o.iconComponent,source:t})}}),onPress:function(){return n?.()}}):React.createElement(S,{label:e,leading:React.createElement(S.Icon,{source:t}),onPress:function(){return n?.()}})}const O=g.findByProps("openLazy","hideActionSheet"),W=g.findByProps("downloadMediaAsset"),{hideActionSheet:p}=g.findByProps("hideActionSheet");function $(e){return e?.attachments?.length?e.attachments.find(function(t){return t?.content_type?.startsWith?.("audio")||t?.filename?.endsWith?.(".ogg")})??null:null}function k(){return h.before("openLazy",O,function(e){const[t,n,o]=e,a=o?.message;n!=="MessageLongPressActionSheet"||!a||t.then(function(r){const c=h.after("default",r,function(i,f){u.React.useEffect(function(){return function(){return c?.()}},[]);const d=C.findInReactTree(f,function(y){return Array.isArray(y)&&y[0]?.type?.name==="ButtonRow"});if(!d)return f;const l=$(a);if(!a.hasFlag?.(8192)||!l)return f;const x=Math.min(d.length,5),q=[u.React.createElement(v,{key:"vm-download",label:"Download Voice Message",icon:m.getAssetIDByName("ic_download_24px"),onPress:async function(){try{await W.downloadMediaAsset(l.url,0)}catch(y){console.error("[VM Download] Failed to download voice message:",y)}finally{p()}}}),u.React.createElement(v,{key:"vm-copy",label:"Copy Voice Message URL",icon:m.getAssetIDByName("copy"),onPress:function(){u.clipboard.setString(l.url),p()}})];return d.splice(x,0,...q),f})})})}const{FormDivider:z,FormIcon:V,FormSwitchRow:b}=E.Forms;function G(){return P.useProxy(s.storage),React.createElement(u.ReactNative.ScrollView,null,React.createElement(b,{label:"Send audio files as Voice Message",leading:React.createElement(V,{source:m.getAssetIDByName("voice_bar_mute_off")}),onValueChange:function(e){return s.storage.sendAsVM=e},value:s.storage.sendAsVM}),React.createElement(z,null),React.createElement(b,{label:"Show every audio file as a Voice Message",leading:React.createElement(V,{source:m.getAssetIDByName("ic_stage_music")}),onValueChange:function(e){return s.storage.allAsVM=e},value:s.storage.allAsVM}))}typeof s.storage.sendAsVM!="boolean"&&(s.storage.sendAsVM=!0),typeof s.storage.allAsVM!="boolean"&&(s.storage.allAsVM=!1);const R=[];function H(){try{R.push(U(),T(),F(),N(),k())}catch(e){console.error("[Voice Message Plugin] Failed to register patches:",e)}}const j=function(){for(const e of R)try{e?.()}catch(t){console.error("[Voice Message Plugin] Error while unpatching:",t)}R.length=0};return H(),A.onUnload=j,A.settings=G,A})({},vendetta.metro,vendetta.patcher,vendetta.plugin,vendetta.metro.common,vendetta.ui.assets,vendetta.utils,vendetta.ui,vendetta.ui.components,vendetta.storage);
